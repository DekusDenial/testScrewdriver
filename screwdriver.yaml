shared:
    image: node:8
    environment:
        USER_SHELL_BIN: bash
annotations:
    screwdriver.cd/restrictPR: all
    screwdriver.cd/chainPR: true
cache:
    event:
        - /sd/meta
    pipeline:
        - /sd/meta
    job:
        set-meta-job: [/sd/meta]

jobs:
    set-meta-job:
        requires: [~pr, ~commit]
        steps:
            - set: |
                meta set foo[2].bar[1] baz
    get-meta-job:
        steps:
            - get: |
                echo $(meta get foo)
    sd-test:
        requires: [~pr, ~commit]
        steps:
            - test: |
                echo first
                echo second
                git diff 431d3e61...origin/master
                echo third
    prjob2:
        requires: [~pr:prjob]
        steps:
            - env: echo $(env)
    test:
        requires: [~pr, ~commit]
        steps:
            - test: env
            #- set: meta set build_version_1 1234567
            #- get: meta get build_version_1
            #- sleep: sleep 60000
            - postecho: |
                cat $SD_SOURCE_DIR/ascii-art.txt
                sleep 7
                echo {0..2}{0..2} | tr ' ' '\n'
                sleep 1
                echo {3..4}{3..4} | tr ' ' '\n'
                exit 1
                echo {a..z}{a..z} | tr ' ' '\n'
            - post: env
    main:
        requires: [~pr, ~commit]
        steps:
            #- set: meta set build_version_1 1234567
            #- get: meta get build_version_1
            #- sleep: sleep 60000
            - postecho: |
                echo {0..9}{0..9} | tr ' ' '\n'
                sleep 3
                cat $SD_SOURCE_DIR/ascii-art.txt
                sleep 1
                echo {a..z}{a..z} | tr ' ' '\n'
                
            #- publish: npx semantic-release
            #- install: npm install screwdriver-template-main
            #- tag: ./node_modules/.bin/template-tag --name tifftemplate --version 1.0.4 --tag meow
    combo-triggered-job:
        steps:
            - echo: echo 'this job is executed by a tag/release push event.'
        requires: [~release, ~tag]
